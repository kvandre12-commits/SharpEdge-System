- name: Ingest SPY intraday (15m) from Alpaca
  env:
    SPY_DB_PATH: data/spy_truth.db
    SYMBOL: SPY
    INTRADAY_TIMEFRAME: "15Min"
    INTRADAY_BARS_TABLE: "spy_bars_15m"
    ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
    ALPACA_API_SECRET: ${{ secrets.ALPACA_API_SECRET }}
  run: |
    python scripts/ingest_spy_intraday_alpaca.py

- name: Debug intraday coverage
  run: |
    python - <<'PY'
    import sqlite3
    con = sqlite3.connect("data/spy_truth.db")
    cur = con.cursor()

    print("Tables:", cur.execute(
        "SELECT name FROM sqlite_master WHERE type='table' ORDER BY name"
    ).fetchall())

    try:
        print("spy_bars_15m count:",
              cur.execute("SELECT COUNT(*) FROM spy_bars_15m").fetchone())
        print("min/max session_date:",
              cur.execute("SELECT MIN(session_date), MAX(session_date) FROM spy_bars_15m").fetchone())
    except Exception as e:
        print("ERROR querying spy_bars_15m:", e)

    con.close()
    PY

- name: Build features (ORB + trend)
  env:
    SPY_DB_PATH: data/spy_truth.db
    SYMBOL: SPY
    INTRADAY_BARS_TABLE: "spy_bars_15m"
    ORB_BARS: "4"
    EDGE_SHARE_FLAG: "0.60"
    TREND_RANGE_PCT_MIN: "0.012"
    TREND_CLOSE_POS_UP: "0.75"
    TREND_CLOSE_POS_DN: "0.25"
    TREND_MAX_WICK_PCT: "0.25"
    TREND_EDGE_SHARE_MAX: "0.60"
  run: |
    python scripts/build_features_spy_daily.py
