name: Ingest SPY data

on:
  workflow_dispatch:
  schedule:
    - cron: "30 22 * * 1-5"

jobs:
  ingest:
    runs-on: ubuntu-latest

    env:
      SPY_DB_PATH: data/spy_truth.db
      SYMBOL: SPY
      INTRADAY_TIMEFRAME: "15Min"
      INTRADAY_BARS_TABLE: spy_bars_15m

      ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
      ALPACA_API_SECRET: ${{ secrets.ALPACA_API_SECRET }}

      FINRA_CLIENT_ID: ${{ secrets.FINRA_CLIENT_ID }}
      FINRA_CLIENT_SECRET: ${{ secrets.FINRA_CLIENT_SECRET }}

      FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Ingest options chain snapshots (Alpaca)
        run: |
          python scripts/ingest_alpaca_options_chain_snapshots.py

      - name: Aggregate options positioning metrics (0-1 DTE)
        run: |
          DTE_MIN=0 DTE_MAX=1 python scripts/aggregate_options_positioning_metrics.py

      - name: Aggregate options positioning metrics (2-3 DTE)
        run: |
          DTE_MIN=2 DTE_MAX=3 python scripts/aggregate_options_positioning_metrics.py
      
      # -----------------------------
      # DAILY BARS
      # -----------------------------
      - name: Ingest SPY daily bars
        run: |
          python scripts/ingest_spy_daily.py
       
      - name: Show DB file size
        run: |
          ls -lh data/
      # =====================================================
      # üîÅ ONE-TIME INTRADAY BACKFILL (RUN ONCE, THEN DELETE)
      # =====================================================
      - name: One-time BACKFILL intraday (15m) from Alpaca
        if: github.event_name == 'workflow_dispatch'
        env:
          MODE: backfill
          START_ISO: "2025-04-01T00:00:00Z"
        run: |
             python scripts/ingest_spy_intraday_alpaca.py || echo "Backfill failed ‚Äì safe to retry"

      # -----------------------------
      # NORMAL INTRADAY (INCREMENTAL)
      # -----------------------------
      - name: Ingest SPY intraday (15m) from Alpaca
        run: |
          if [ -z "$ALPACA_API_KEY" ] || [ -z "$ALPACA_API_SECRET" ]; then
            echo "ALPACA creds missing ‚Äî skipping intraday"
            exit 0
          fi
          python scripts/ingest_spy_intraday_alpaca.py

      - name: Debug intraday coverage
        run: |
          python - <<'PY'
          import sqlite3
          con = sqlite3.connect("data/spy_truth.db")
          cur = con.cursor()
          print(
              "spy_bars_15m rows:",
              cur.execute("SELECT COUNT(*) FROM spy_bars_15m").fetchone()
          )
          con.close()
          PY

      # -----------------------------
      # FEATURES / REGIMES
      # -----------------------------
      - name: Build daily features (ORB + trend)
        run: |
          python scripts/build_features_spy_daily.py

      - name: Build fused intraday trend probability (11:30)
        run: |
          python scripts/build_intraday_trendday_prob_1130_fused.py

      - name: Build execution state daily (final bias)
        run: |
          python scripts/build_execution_state_daily.py
      # -----------------------------
      # CONTEXT / REGIMES
      # -----------------------------
      - name: Build liquidity regime (daily)
        run: |
          python scripts/build_liquidity_regime_daily.py

      - name: Export liquidity regime CSV
        run: |
          python scripts/exports/export_liquidity_regime_csv.py

      - name: Build open resolution regime (intraday)
        run: |
          python scripts/build_open_resolution_regime_intraday.py
          
      - name: FINRA darkpool overlay
        run: |
          if [ -z "$FINRA_CLIENT_ID" ] || [ -z "$FINRA_CLIENT_SECRET" ]; then
            echo "FINRA creds missing ‚Äî skipping FINRA overlay"
            exit 0
          fi
          python scripts/ingest_finra_darkpool_overlay.py

      - name: FRED macro overlays
        run: |
          if [ -z "$FRED_API_KEY" ]; then
            echo "FRED_API_KEY missing ‚Äî skipping FRED overlays"
            exit 0
          fi
          python scripts/ingest_fred_overlays.py

      - name: Build regime (daily)
        run: |
          python scripts/build_regime_spy_daily.py

      # -----------------------------
      # SIGNALS / PLAYBOOK
      # -----------------------------
      - name: Build signal strength (daily)
        run: |
          python scripts/build_signal_strength_daily.py
      
      - name: Run playbook (signals + auto DTE + trade cards)
        run: |
          python scripts/run_playbook.py

      # -----------------------------
      # PROOF OF EDGE
      # -----------------------------
      - name: Evaluate trade-gate edge
        run: |
          python scripts/analysis/evaluate_trade_gate_edge.py

      - name: Validate full pipeline outputs
        run: |
          python scripts/utils/validate_pipeline_outputs.py

      # -----------------------------
      # OPTIONAL MANUAL CALIBRATION
      # -----------------------------
      - name: Calibrate DTE from backtest (manual only)
        if: github.event_name == 'workflow_dispatch'
        run: |
          python scripts/calibrate_dte_from_backtest.py

      # -----------------------------
      # COMMIT ARTIFACTS
      # -----------------------------
      - name: Commit updated DB + outputs
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add data/ outputs/ sql/ scripts/ || true
          git diff --staged --quiet && echo "No changes to commit" && exit 0
          git commit -m "Daily pipeline + regimes + signals + proof-of-edge artifacts"
          git push

      # -----------------------------
      # FINAL PUBLISHED ARTIFACT
      # -----------------------------
      - name: Post FINAL trade card to Discord
        run: |
          python scripts/send_trade_card_to_discord.py
