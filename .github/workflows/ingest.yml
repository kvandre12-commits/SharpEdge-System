name: Ingest SPY data
permissions:
  contents: write
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  ingest:
    runs-on: ubuntu-latest

    env:
      SPY_DB_PATH: data/spy_truth.db
      SYMBOL: SPY
      INTRADAY_TIMEFRAME: "15Min"
      INTRADAY_BARS_TABLE: "spy_bars_15m"
      ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
      ALPACA_API_SECRET: ${{ secrets.ALPACA_API_SECRET }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Ingest SPY intraday (15m) from Alpaca
        run: |
          python scripts/ingest_spy_intraday_alpaca.py

      - name: Debug intraday coverage
        run: |
          python - <<'PY'
          import sqlite3
          con = sqlite3.connect("data/spy_truth.db")
          cur = con.cursor()

          print("Tables:", cur.execute(
              "SELECT name FROM sqlite_master WHERE type='table' ORDER BY name"
          ).fetchall())

          try:
              print("spy_bars_15m count:",
                    cur.execute("SELECT COUNT(*) FROM spy_bars_15m").fetchone())
          except Exception as e:
              print("spy_bars_15m missing:", e)

          con.close()
          PY

      - name: Build daily features
        run: |
          python scripts/build_features_spy_daily.py

      - name: Commit outputs
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add outputs/*.csv data/spy_truth.db || true
          git commit -m "Update outputs" || echo "Nothing to commit"
          git push
